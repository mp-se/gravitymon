<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <title>Beer Gravity Monitor</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" integrity="sha384-zCbKRCUGaJDkqS1kPbPd7TveP5iyJE0EjAuZQTgFLD2ylzuqKfdKlfG/eSrtxUkn" crossorigin="anonymous">  
  <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-fQybjgWLrvvRgtW6bFlB7jaZrFsaBXjsOMm/tB9LTS58ONXgqbR9W8oWht/amnpF" crossorigin="anonymous"></script>
</head>

<body class="py-4">

<!-- START MENU -->

<nav class="navbar navbar-expand-sm navbar-dark bg-primary">
  <a class="navbar-brand" href="/index.htm">Beer Gravity Monitor</a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="navbar"> 
    <ul class="navbar-nav mr-auto">
      <li class="nav-item active">
        <a class="nav-link" href="/index.htm">Home <span class="sr-only">(current)</span></a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/device.htm">Device</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/config.htm">Configuration</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/calibration.htm">Calibration</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="/about.htm">About</a>
      </li>
    </ul>

    <div class="spinner-border text-light" id="spinner" role="status"></div>
  </div>
</nav>

<!-- START MAIN INDEX -->

<div class="container">

  <hr class="my-4">

  <div class="alert alert-success alert-dismissible fade hide show d-none" role="alert" id="alert">
    <div id="alert-msg">...</div>
    <button type="button" id="alert-btn" class="close" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <script type="text/javascript">
    function showError( msg ) {
      $('.alert').removeClass('alert-success').addClass('alert-danger').removeClass('d-none').addClass('show')
      $('#alert-msg').text( msg );
    }

    function showSuccess( msg ) {
      $('.alert').addClass('alert-success').removeClass('alert-danger').removeClass('d-none').addClass('show')
      $('#alert-msg').text( msg );
    }

    $("#alert-btn").click(function(e){
      $('.alert').addClass('d-none').removeClass('show')
    });    
  </script>

  <div class="" id="id" hidden></div>

  <div class="row mb-3">
    <div class="col-md-8 themed-grid-col bg-light">Gravity:</div>
    <div class="col-md-4 themed-grid-col bg-light" id="gravity">Loading...</div>
  </div>
  <div class="row mb-3">
    <div class="col-md-8 themed-grid-col bg-light">Temperature:</div>
    <div class="col-md-4 themed-grid-col bg-light" id="temp">Loading...</div>
  </div>
  <div class="row mb-3">
    <div class="col-md-8 themed-grid-col bg-light">Angle/Tilt:</div>
    <div class="col-md-4 themed-grid-col bg-light" id="angle">Loading...</div>
  </div>
  <div class="row mb-3">
    <div class="col-md-8 themed-grid-col bg-light">Battery:</div>
    <div class="col-md-4 themed-grid-col bg-light" id="battery">Loading...</div>
  </div>

  <div class="row mb-3">
    <div class="col-md-12 px-md-5 themed-grid-col bg-light custom-control custom-checkbox">
      <input type="checkbox" class="custom-control-input" name="sleep-mode" id="sleep-mode" disabled>
      <label class="custom-control-label" for="sleep-mode">Do not enter sleep mode when floating (check this if you are collecting angles/tilt for calibration).</label>
    </div>        
  </div>      

  <hr class="my-4">
</div>

<script type="text/javascript">
  window.onload = start;

  $("#sleep-mode").click(function(e){
    console.log( "Blocking sleep mode = " + $("#sleep-mode").is(":checked"));
    $.ajax( { 
      type: "POST",  
      url: "/api/status/sleepmode", 
      data: { "id": $("#id").text(), "sleep-mode": $("#sleep-mode").is(":checked")  }, 
      success: function(result) { },
      error: function(result) { showError('Could not update sleep mode for device.'); },
    } );
  });

  function getStatus() {
    var url = "/api/status";
    //var url = "/test/status.json";
    $('#spinner').show(); 
    $.getJSON(url, function (cfg) {
      console.log( cfg );
      $("#id").text(cfg["id"]);
     
      var angle = cfg["angle"];
      
      if(angle==0) {
        $("#angle").text("Gyro moving"); 
        $("#gravity").text("Gyro moving");
      } else {
        $("#angle").text(cfg["angle"]);
      
        if( cfg["gravity-format"] == "G")
          $("#gravity").text(cfg["gravity"] + " SG");
        else
          $("#gravity").text(cfg["gravity"] + " Â°P");
      }

      var batt = cfg["battery"];
      var charge = 0;

      if(batt>4.15) charge = 100;
      else if(batt>4.05) charge = 90;
      else if(batt>3.97) charge = 80;
      else if(batt>3.91) charge = 70;
      else if(batt>3.86) charge = 60;
      else if(batt>3.81) charge = 50;
      else if(batt>3.78) charge = 40;
      else if(batt>3.76) charge = 30;
      else if(batt>3.73) charge = 20;
      else if(batt>3.67) charge = 10;
      else if(batt>3.44) charge = 5;

      $("#battery").text(batt + " V (" + charge + "%)" );

      if( cfg["temp-format"] == "C") 
        $("#temp").text(cfg["temp-c"] + " C");
      else 
        $("#temp").text(cfg["temp-f"] + " F");

      if( cfg["sleep-mode"] ) 
        $("#sleep-mode").attr("checked", true );
      else 
        $("#sleep-mode").attr("checked", false );
      $("#sleep-mode").removeAttr("disabled");
    })
    .fail(function () {
      showError('Unable to get data from the device.');
    })
    .always(function() {
      $('#spinner').hide(); 
    });
  }

  function start() {
    setInterval(getStatus, 3000);
  }
</script>

<!-- START FOOTER -->

<div class="container-fluid themed-container bg-primary text-light">(C) Copyright 2021-22 Magnus Persson</div>
</body>
</html>